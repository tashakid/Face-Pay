<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Test - FacePay</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #09090b;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            min-height: 100vh;
        }
        h1 { color: #ccff00; }
        .container {
            max-width: 600px;
            width: 100%;
        }
        .status {
            background: #18181b;
            border: 1px solid #27272a;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .status-item {
            margin: 10px 0;
        }
        .status-label {
            color: #a1a1aa;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .status-value {
            color: white;
            font-size: 16px;
        }
        .video-container {
            background: #18181b;
            border: 2px solid #27272a;
            border-radius: 16px;
            overflow: hidden;
            margin: 20px 0;
            max-width: 640px;
            aspect-ratio: 4/3;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        button {
            background: #ccff00;
            border: none;
            color: black;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        button:hover {
            background: #b8e600;
        }
        button:disabled {
            background: #52525b;
            cursor: not-allowed;
            color: #a1a1aa;
        }
        .error {
            color: #ef4444;
            background: #7f1d1d;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .success {
            color: #22c55e;
            background: #14532d;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .info {
            color: #3b82f6;
            background: #1e3a8a;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ“· Camera Diagnostic Tool</h1>

        <div class="status">
            <div class="status-item">
                <div class="status-label">Current Protocol</div>
                <div class="status-value" id="protocol">Checking...</div>
            </div>
            <div class="status-item">
                <div class="status-label">MediaDevices Support</div>
                <div class="status-value" id="mediaDevicesSupport">Checking...</div>
            </div>
            <div class="status-item">
                <div class="status-label">Available Cameras</div>
                <div class="status-value" id="availableCameras">Not checked</div>
            </div>
            <div class="status-item">
                <div class="status-label">Camera Permission Status</div>
                <div class="status-value" id="permissionStatus">Not checked</div>
            </div>
        </div>

        <button id="startBtn" onclick="requestCamera()">Request Camera Access</button>
        <button id="enumerateBtn" onclick="enumerateDevices()">List All Cameras</button>

        <div id="messages"></div>

        <div class="video-container">
            <video id="video" autoplay playsinline muted></video>
        </div>

        <div class="info" style="font-size: 12px; margin-top: 20px;">
            <strong>Tips:</strong>
            <ul style="margin: 10px 0 10px 20px;">
                <li>Camera API only works on HTTPS or localhost</li>
                <li>If denied, click the camera icon in your browser's address bar</li>
                <li>Make sure no other app is using the camera</li>
                <li>In WSL/VM, pass through a physical camera</li>
            </ul>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const messages = document.getElementById('messages');
        let currentStream = null;

        function addMessage(type, text) {
            const div = document.createElement('div');
            div.className = type;
            div.textContent = text;
            messages.appendChild(div);
            console.log(`[${type}] ${text}`);
        }

        function checkProtocol() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            const isSecure = protocol === 'https:';
            const isLocalhost = hostname === 'localhost' || hostname === '127.0.0.1';

            const protocolEl = document.getElementById('protocol');
            if (isSecure) {
                protocolEl.textContent = 'âœ… HTTPS (camera will work)';
                protocolEl.style.color = '#22c55e';
            } else if (isLocalhost) {
                protocolEl.textContent = 'âœ… HTTP on localhost (camera will work)';
                protocolEl.style.color = '#22c55e';
            } else {
                protocolEl.textContent = 'âŒ HTTP NOT on localhost (camera will NOT work)';
                protocolEl.style.color = '#ef4444';
            }
        }

        function checkMediaDevicesSupport() {
            const supportEl = document.getElementById('mediaDevicesSupport');
            if ('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices) {
                supportEl.textContent = 'âœ… Supported';
                supportEl.style.color = '#22c55e';
            } else {
                supportEl.textContent = 'âŒ Not supported by this browser';
                supportEl.style.color = '#ef4444';
            }
        }

        async function enumerateDevices() {
            document.getElementById('availableCameras').textContent = 'Loading...';

            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const cameras = devices.filter(device => device.kind === 'videoinput');

                const camerasEl = document.getElementById('availableCameras');
                if (cameras.length === 0) {
                    camerasEl.textContent = 'âŒ No cameras found';
                    camerasEl.style.color = '#ef4444';
                    addMessage('error', 'No camera devices detected. Make sure a camera is connected.');
                } else {
                    camerasEl.textContent = `âœ… ${cameras.length} camera(s) found`;
                    camerasEl.style.color = '#22c55e';

                    cameras.forEach((camera, index) => {
                        addMessage('info', `Camera ${index + 1}: ${camera.label || 'Unlabeled (permission denied)'}`);
                    });
                }
            } catch (err) {
                document.getElementById('availableCameras').textContent = 'âŒ Error checking devices';
                addMessage('error', `Failed to enumerate devices: ${err.message}`);
                console.error(err);
            }
        }

        async function requestCamera() {
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = true;
            startBtn.textContent = 'Requesting...';
            messages.innerHTML = '';

            try {
                addMessage('info', 'Requesting camera access...');

                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    },
                    audio: false
                });

                currentStream = stream;

                document.getElementById('permissionStatus').textContent = 'âœ… Granted';
                document.getElementById('permissionStatus').style.color = '#22c55e';

                video.srcObject = stream;
                await video.play();

                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();

                addMessage('success', `Camera active! Resolution: ${settings.width}x${settings.height}`);

                startBtn.textContent = 'Stop Camera';
                startBtn.onclick = stopCamera;
                startBtn.disabled = false;

            } catch (err) {
                const errorName = err.name;
                let errorMessage = `Camera access failed: ${err.name}`;

                if (errorName === 'NotAllowedError' || errorName === 'PermissionDeniedError') {
                    errorMessage = 'Camera permission denied. Click the camera icon in your browser address bar and allow access.';
                    document.getElementById('permissionStatus').textContent = 'âŒ Denied';
                    document.getElementById('permissionStatus').style.color = '#ef4444';
                } else if (errorName === 'NotFoundError' || errorName === 'DevicesNotFoundError') {
                    errorMessage = 'No camera found. Please connect a camera.';
                } else if (errorName === 'NotReadableError' || errorName === 'TrackStartError') {
                    errorMessage = 'Camera is already in use by another application.';
                } else if (errorName === 'OverconstrainedError') {
                    errorMessage = 'Camera does not support the requested settings.';
                }

                addMessage('error', errorMessage);
                console.error('Camera error:', err);

                startBtn.textContent = 'Request Camera Access';
                startBtn.disabled = false;
            }
        }

        function stopCamera() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                currentStream = null;
            }

            const startBtn = document.getElementById('startBtn');
            startBtn.textContent = 'Request Camera Access';
            startBtn.onclick = requestCamera;
            startBtn.disabled = false;

            document.getElementById('permissionStatus').textContent = 'Stopped';
            document.getElementById('permissionStatus').style.color = '#a1a1aa';

            addMessage('info', 'Camera stopped');
        }

        window.addEventListener('load', () => {
            checkProtocol();
            checkMediaDevicesSupport();
        });

        window.addEventListener('beforeunload', stopCamera);
    </script>
</body>
</html>